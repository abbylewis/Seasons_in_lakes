---
title: "Plot"
author: "Abby Lewis"
date: "2024-02-29"
output: html_document
---

# Set-up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(ggnewscale) # For multiple color scales on the discrete panel

#The ../03a_Figures folder is not pushed to GitHub
if(!file.exists("../03a_Figures")){dir.create("../03a_Figures")}

#Southern hemisphere lakes
sh_lakes <- c("Rerewhakaaitu")
```

# Discrete

NOTE: add color for mixed period

```{r}
#Load discrete data
#BVR
ice_format <- read.csv("../01b_Processed_data/BVR_ice.csv") %>%
  mutate(Method = "Ice") %>%
  full_join(data.frame(Lake = "Rerewhakaaitu",
                       Season = "Open water",
                       Method = "Ice",
                       start = 0,
                       end = 365))
strat <- read.csv("../01b_Processed_data/BVR_stratification_discrete.csv") 
#General
temperate_raw <- read.csv("../01b_Processed_data/Temperate_seasons.csv")
#Rerewhakaaitu
rere_strat <- read.csv("../01b_Processed_data/Rerewhakaaitu_stratification_discrete.csv") 

#Format
in_lake <- strat %>% 
  full_join(rere_strat) %>%
  mutate(Method = "Stratification",
         x = start,
         xend = end)

#Format
temperate <- temperate_raw %>% filter(is.na(start)) #make empty df
for(lake in unique(in_lake$Lake)) {
  hemi <- ifelse(lake %in% sh_lakes, "Southern", "Northern")
  temperate <- temperate %>%
    full_join(temperate_raw %>% mutate(Lake = lake) %>%
                filter(Hemisphere == hemi))
}

#Plot
#First the temperate metrics
discrete_temperate <- temperate %>%
  filter(Method == "Months") %>%
  ggplot(aes(y = Method, 
             yend = Method, 
             x = start, 
             xend = end, 
             color = Season)) +
  geom_segment(lwd = 5) +
  theme_bw() +
  ggtitle("Discrete seasonal clasifications") +
  scale_color_manual("Temperate\nseasons",
                     values = c("grey80", "grey67", "grey37", "grey10", 
                                "grey", "grey", "grey", "grey"), #placeholders
                     breaks = c("Winter", "Spring", "Summer", "Autumn")) +
  scale_x_continuous(breaks = c(0, 90, 183, 276, 365),
                 labels = c("Winter\nsolstice", "Spring\nequinox", 
                            "Summer\nsolstice", "Autumn\nequinox", "Winter\nsolstice")) +
  guides(color = guide_legend(ncol = 1, title.position="top")) +
  facet_wrap(~Lake, ncol = 1)

#Add in-lake data (with separate color legend)
discrete_strat <- discrete_temperate +
  ggnewscale::new_scale_color() +
  geom_segment(data = in_lake, 
               aes(y = Method, 
                   yend = Method, 
                   x = start, 
                   xend = end, 
                   color = Season), 
               lwd = 5) +
  scale_color_manual("Stratification", values = c("blue", "#FACFCF", "#F05D5E"),
                     breaks = c("Inversely\nstratified", "Mixed", "Stratified")) +
  guides(color = guide_legend(ncol = 1, title.position="top")) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank(),
        legend.title = element_text(vjust = 1),
        panel.grid.major.x = element_line(color = "grey70"),
        panel.grid.major.y = element_blank(),
        strip.background = element_rect(fill = "white", color = "white"),
        legend.key.height = unit(0, "mm"),
        legend.key.spacing.y = unit(0, "mm"),
        panel.grid.minor = element_blank()) +
  facet_wrap(~Lake, ncol = 1)
discrete_strat

discrete_ice <- discrete_strat +
  ggnewscale::new_scale_color() +
  geom_segment(data = ice_format,
               aes(y = Method, 
                   yend = Method, 
                   x = start, 
                   xend = end, 
                   color = Season), 
               lwd = 5) +
  scale_color_manual("Ice", values = c("#8AB4E3", "#E5EDF7"),
                     breaks = c("Open water", "Ice")) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank(),
        legend.title = element_text(vjust = 1),
        panel.grid.major.x = element_line(color = "grey70"),
        panel.grid.major.y = element_blank(),
        legend.key.height = unit(0, "mm"),
        strip.background = element_rect(fill = "white", color = "white"),
        legend.key.spacing.y = unit(0, "mm"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(ncol = 1, title.position="top")) +
  facet_wrap(~Lake, ncol = 1)

#View
discrete_ice
```

# Continuous

```{r}
#Load data
#BVR
bvr_catwalk_format <- read.csv("../01b_Processed_data/BVR_catwalk.csv")
bvr_met_format <- read.csv("../01b_Processed_data/BVR_met.csv")
bvr_strat <- read.csv("../01b_Processed_data/BVR_stratification_continuous.csv")
#Rerewhakaaitu
rere_in_lake <- read.csv("../01b_Processed_data/Rerewhakaaitu_continuous.csv")
rere_strat <- read.csv("../01b_Processed_data/Rerewhakaaitu_stratification_continuous.csv")
rere_met <- read.csv("../01b_Processed_data/Rerewhakaaitu_met.csv")

#Format
#A bit of magic to get explicit NAs
full <- bvr_catwalk_format %>%
  full_join(bvr_met_format) %>%
  full_join(bvr_strat) %>%
  full_join(rere_in_lake) %>%
  full_join(rere_strat) %>%
  full_join(rere_met) %>%
  expand(Variable, yday, Lake)

continuous_data <- bvr_catwalk_format %>%
  full_join(bvr_met_format) %>%
  full_join(bvr_strat) %>%
  full_join(rere_in_lake) %>%
  full_join(rere_strat) %>%
  full_join(rere_met) %>%
  right_join(full) %>%
  mutate(Variable = factor(Variable, 
                           levels = c("Surface_temperature", 
                                      "AirTemp_C_Average", 
                                      "Surface_chla", 
                                      "Shortwave",
                                      "Diff_Dens_surf_bot"),
                           labels = c("Surface temperature", 
                                      "Air temperature",
                                      "Surface chlorophyll-a",
                                      "Shortwave",
                                      "Epi-hypo dens. difference"))) %>%
  filter(!is.na(Variable)) %>%
  group_by(Variable, Lake) %>%
  mutate(Value = (Value)/(max(Value, na.rm = T))) %>%
  mutate(x = yday) %>%
  mutate(var_class = ifelse(Variable == "Surface chlorophyll-a", "Bio", "Phys"))

#Plot
continuous <- continuous_data %>%
  ggplot(aes(x = x, y = Value * 100, color = Variable)) +
  scale_color_manual(values = c("#6B7CB3","#1F363D","#8DD65C", "#FFC233", "#F05D5E")) +
  geom_line(alpha = 0.2) +
  geom_smooth(se = F, method = "gam") +
  theme_bw() + 
  ylab("% of max") +
  ggtitle("Seasonally-varying parameters")  +
  guides(color = guide_legend(ncol = 1)) +
  scale_x_continuous(breaks = c(0, 90, 183, 276, 365),
                 labels = c("Winter\nsolstice", "Spring\nequinox", 
                            "Summer\nsolstice", "Autumn\nequinox", "Winter\nsolstice")) +
  facet_wrap(~Lake, ncol = 1) +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white", color = "white"),
        legend.key.height = unit(3, "mm"),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "grey80"))

#View
continuous
```

# Combine and save

```{r}
jpeg("../03a_Figures/Seasons_data.jpg", width = 9, height = 5, units = "in", res = 300)
ggarrange(discrete_strat, continuous, align = "h")
dev.off()

jpeg("../03a_Figures/Seasons_data_ice.jpg", width = 8.5, height = 4.5, units = "in", res = 300)
ggarrange(discrete_ice, continuous, align = "h")
dev.off()
```
```{r}
discrete_ice2 <- discrete_strat +
  ggnewscale::new_scale_color() +
  geom_segment(data = ice_format,
               aes(y = Method, 
                   yend = Method, 
                   x = start, 
                   xend = end, 
                   color = Season), 
               lwd = 5) +
  scale_color_manual("Ice", values = c("#8AB4E3", "#E5EDF7"),
                     breaks = c("Open water", "Ice")) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank(),
        legend.title = element_text(vjust = 1),
        panel.grid.major.x = element_line(color = "grey70"),
        panel.grid.major.y = element_blank(),
        legend.key.height = unit(0, "mm"),
        strip.background = element_rect(fill = "white", color = "white"),
        legend.key.spacing.y = unit(0, "mm"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(ncol = 1, title.position="top")) +
  facet_grid(rows = vars(Lake))

continuous2 <- continuous_data %>%
  ggplot(aes(x = x, y = Value * 100, color = Variable)) +
  scale_color_manual(values = c("#6B7CB3","#1F363D","#8DD65C", "#FFC233", "#F05D5E")) +
  geom_line(alpha = 0.2) +
  geom_smooth(se = F, method = "gam") +
  theme_bw() + 
  ylab("% of max") +
  ggtitle("Seasonally-varying parameters")  +
  guides(color = guide_legend(ncol = 1)) +
  scale_x_continuous(breaks = c(0, 90, 183, 276, 365),
                 labels = c("Winter\nsolstice", "Spring\nequinox", 
                            "Summer\nsolstice", "Autumn\nequinox", "Winter\nsolstice")) +
  facet_grid(rows = vars(Lake), cols = vars(var_class)) +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white", color = "white"),
        legend.key.height = unit(3, "mm"),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "grey80"),
        strip.text.x = element_blank())

jpeg("../03a_Figures/Seasons_data_ice2.jpg", width = 8.5, height = 4.5, units = "in", res = 300)
ggarrange(discrete_ice2, continuous2, widths = c(1,1.5), align = "h")
dev.off()
```

