---
title: "Plot"
author: "Abby Lewis"
date: "2024-02-29"
output: html_document
---

# Set-up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(ggnewscale) # For multiple color scales on the discrete panel

#The ../03a_Figures folder is not pushed to GitHub
if(!file.exists("../03a_Figures")){dir.create("../03a_Figures")}

#Southern hemisphere offset
offset = 184
sh_lakes <- c("Rerewhakaaitu")
```

# Discrete

NOTE: add color for mixed period

```{r}
#Load discrete data
#FCR
ice_format <- read.csv("../01b_Processed_data/FCR_ice.csv") 
strat <- read.csv("../01b_Processed_data/FCR_stratification_discrete.csv") 
#General
nh <- read.csv("../01b_Processed_data/Temperate_seasons_nh.csv")
sh <- read.csv("../01b_Processed_data/Temperate_seasons_sh.csv")
#Rerewhakaaitu
rere_strat <- read.csv("../01b_Processed_data/Rerewhakaaitu_stratification_discrete.csv") 

#Format
in_lake <- ice_format %>%
  full_join(strat) %>% 
  full_join(rere_strat) %>%
  mutate(Method = "Ice/Stratification",
         x = ifelse(Lake %in% sh_lakes, start - offset, start),
         xend = ifelse(Lake %in% sh_lakes, end - offset, end))

#Format
temperate <- nh %>% filter(is.na(start)) #make empty df
for(lake in unique(in_lake$Lake)) {
  if(lake %in% sh_lakes) {
    temperate <- temperate %>%
      full_join(sh %>% mutate(Lake = lake))
  } else {
    temperate <- temperate %>%
      full_join(nh %>% mutate(Lake = lake))
  }
}

#Plot
#First the temperate metrics
discrete_temperate <- temperate %>%
  mutate(x = ifelse(Hemisphere == "Southern", start - offset, start),
         xend = ifelse(Hemisphere == "Southern", end - offset, end)) %>%
  ggplot(aes(y = Method, 
             yend = Method, 
             x = as.Date("2021-01-01") + x, 
             xend = as.Date("2021-01-01") + xend, 
             color = Season)) +
  geom_segment(lwd = 5) +
  theme_bw() +
  ggtitle("Discrete seasonal clasifications") +
  scale_color_manual("Temperate\nseasons",
                     values = c("lightblue", "pink", "goldenrod2", "#cc5500", 
                                "grey", "grey"), #placeholders
                     breaks = c("Winter", "Spring", "Summer", "Autumn")) +
  scale_x_date(date_labels = "%b") +
  guides(color = guide_legend(ncol = 1)) +
  facet_wrap(~Lake, ncol = 1)

#Add in-lake data (with separate color legend)
discrete <- discrete_temperate +
  ggnewscale::new_scale_color() +
  geom_segment(data = in_lake, 
               aes(y = Method, 
                   yend = Method, 
                   x = as.Date("2021-01-01") + x, 
                   xend = as.Date("2021-01-01") + xend, 
                   color = Season), 
               lwd = 5) +
  scale_color_manual("In-lake\nseasons", values = c("lightblue", "goldenrod2"),
                     breaks = c("Ice", "Stratified")) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank(),
        legend.title = element_text(vjust = 1)) +
  guides(color = guide_legend(ncol = 1)) +
  facet_wrap(~Lake, ncol = 1, scales = "free_x")

#View
discrete
```

# Continuous

```{r}
#Load data
#FCR
fcr_catwalk_format <- read.csv("../01b_Processed_data/FCR_catwalk.csv")
fcr_met_format <- read.csv("../01b_Processed_data/FCR_met.csv")
fcr_strat <- read.csv("../01b_Processed_data/FCR_stratification_continuous.csv")
#Rerewhakaaitu
rere_in_lake <- read.csv("../01b_Processed_data/Rerewhakaaitu_continuous.csv")
rere_strat <- read.csv("../01b_Processed_data/Rerewhakaaitu_stratification_continuous.csv")
rere_met <- read.csv("../01b_Processed_data/Rerewhakaaitu_met.csv")

#Format
continuous_data <- fcr_catwalk_format %>%
  full_join(fcr_met_format) %>%
  full_join(fcr_strat) %>%
  full_join(rere_in_lake) %>%
  full_join(rere_strat) %>%
  full_join(rere_met) %>%
  filter(!is.na(Value)) %>%
  mutate(Variable = factor(Variable, 
                           levels = c("Surface_temperature", 
                                      "AirTemp_C_Average", 
                                      "Surface_chla", 
                                      "Shortwave",
                                      "Diff_Dens_surf_bot"),
                           labels = c("Surface temperature", 
                                      "Air temperature",
                                      "Surface chlorophyll-a",
                                      "Shortwave",
                                      "Epi-hypo dens. difference")),
         Lake = ifelse(is.na(Lake), "FCR", Lake)) %>%
  filter(!is.na(Variable)) %>%
  group_by(Variable, Lake) %>%
  mutate(Value = (Value)/(max(Value))) %>%
  mutate(x = ifelse(Lake %in% sh_lakes, yday - offset, yday))

#Plot
continuous <- continuous_data %>%
  ggplot(aes(x = as.Date("2021-01-01") + x, y = Value * 100, color = Variable)) +
  scale_color_manual(values = c("purple","pink", "#26c9a3", "goldenrod", "grey50")) +
  geom_line(alpha = 0.3) +
  geom_smooth(se = F, method = "gam") +
  theme_bw() + 
  scale_x_date(date_labels = "%b") +
  ylab("% of max") +
  ggtitle("Seasonally-varying parameters")  +
  guides(color = guide_legend(ncol = 1, byrow = T)) +
  facet_wrap(~Lake, ncol = 1, scales = "free_x") +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        legend.spacing.y = unit(-1.0, "cm"))

#View
continuous
```

# Combine and save

```{r}
jpeg("../03a_Figures/Seasons_data.jpg", width = 9, height = 5, units = "in", res = 300)
ggarrange(discrete, continuous, align = "h")
dev.off()
```
