---
title: "Lit review"
author: "Abby Lewis"
date: "2025-10-24"
output: html_document
---

Setup: load data and functions

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
source("lit_review_helper_scripts/text_vectors.R")
source("lit_review_helper_scripts/country_detection.R")
library(stringi)
library(data.table)

#https://simplemaps.com/data/world-cities
places <- fread("../01a_Raw_data/worldcities.csv") %>%
  mutate(country = case_match(country,
                              "Korea, South"~"South Korea",
                              "Korea, North"~"North Korea",
                              "Burma"~"Myanmar",
                              "Czechia"~"Czech Republic",
                              "Virgin Islands, British"~"British Virgin Islands",
                              "Micronesia, Federated States of"~"Federated States of Micronesia",
                              "Bahamas, The"~"The Bahamas",
                              "Gambia, The"~"The Gambia",
                              .default = country))

#Load files
files <- list.files("../05_Lit_review", full.names = T)
all <- read_delim(files, show_col_types = F, delim = "\t") %>%
  select(TI, AB, PY) %>%
  distinct()

#Separate WoS search for just "lake" in title, abstract, and keywords
lake <- read_delim("../01a_Raw_data/WoS_lake_24Nov25.txt", delim = "\t", 
                   col_names = c("Year", "Count", "Percent"), skip = 1)

#Country demonyms
demonyms <- read_csv("../01a_Raw_data/Demonyms.csv")

#For circle plots
compute_angle = function(perc){
  angle = -1
  
  if(perc < 0.5) # 1st half [90, -90]
    angle = (180 - (perc/0.5) * 180) - 90
  else # 2nd half [90, -90]
    angle = (90 - ((perc - 0.5)/0.5) * 180)

  return(angle)
}

#Standardized colors throughout
colors <- c(
  Hydrology      = "#64c7cc",
  Flora          = "#11592b",
  Fauna          = "#8f6501",
  Temperature    = "#993355",
  `Ice/Snow`     = "#8AB4E3",
  Economic       = "#ddbb66",
  Research       = "#66450c",
  Agriculture    = "#79ad24",
  Stratification = "#F6A2A2",
  Other          = "grey20",
  Temperate      = "grey"
)
```

Identify seasons in title/abstract

```{r}
#Identify spring/summer/autumn/winter
all_classified <- all %>%
  mutate(full_text = tolower(paste(TI, AB))) %>%
  select(-AB) %>% #decrease df size 
  mutate(Spring = grepl("spring", full_text, ignore.case = T),
         Summer = grepl("summer", full_text, ignore.case = T),
         Autumn = grepl("autumn|fall", full_text, ignore.case = T),
         Winter = grepl("winter", full_text, ignore.case = T))

#Identify season words
processed <- all_classified %>%
  mutate(
    # Normalize "low water", "warm water" etc. before extraction
    full_text = str_replace_all(full_text,
                         regex("\\b([a-z]+)[-\\s]?water\\b", 
                               ignore_case = TRUE),
                         "\\1-water"),
    
    # Normalize "low flow", "high flow" etc. before extraction
    full_text = str_replace_all(full_text,
                         regex("\\b([a-z]+)[-\\s]?flow\\b", 
                               ignore_case = TRUE),
                         "\\1-flow"),
    
    # Normalize rain/rainy before extraction
    full_text = str_replace_all(full_text, regex("\\brain[[:space:]]+season\\b", 
                                   ignore_case = TRUE), "rainy season"),
    
    # Normalize "non", post, and pre before extraction
    full_text = str_replace_all(full_text, regex("\\bnon(?!-)", ignore_case = TRUE), "non-"),
    full_text = str_replace_all(full_text, regex("\\bpost(?!-)", ignore_case = TRUE), "post-"),
    full_text = str_replace_all(full_text, regex("\\bpre[[:space:]]", ignore_case = TRUE), "pre-"),
    
    # Normalize ice free before extraction
    full_text = str_replace_all(full_text, regex("\\bice[[:space:]]+free[[:space:]]+season\\b", 
                                   ignore_case = TRUE), "ice-free season"),
    
    # Normalize ice cover before extraction
    full_text = str_replace_all(full_text, regex("\\bice[[:space:]-]+cover(?:ed)?[[:space:]]+season\\b", 
                                   ignore_case = TRUE), "ice-cover season"),
    
    #Extract
    SeasonWords = lapply(str_extract_all(full_text, 
                                         regex("\\b[\\w-]+(?=[[:space:]-]+seasons?\\b)", 
                                               ignore_case = TRUE)),
                         function(x) unique(x))
  )

season_word_counts <- processed %>%
  select(SeasonWords) %>%
  unnest(SeasonWords) %>%
  mutate(SeasonWords = gsub("[[:space:]-]$", "", SeasonWords)) %>%
  filter(!SeasonWords %in% filler_words,  # remove words that aren't seasons
         !SeasonWords %in% temporal_phases,
         !is.na(SeasonWords)) %>%  
  mutate( #Classify season "type"
    Type = case_when(
      SeasonWords %in% temperate ~ "Temperate",
      SeasonWords %in% flora ~ "Flora",
      SeasonWords %in% fauna ~ "Fauna",
      SeasonWords %in% ice ~ "Ice/Snow",
      SeasonWords %in% stratification ~ "Stratification",
      SeasonWords %in% temperature ~ "Temperature",
      SeasonWords %in% hydrology ~ "Hydrology",
      SeasonWords %in% agriculture ~ "Agriculture",
      SeasonWords %in% economic ~ "Economic",
      SeasonWords %in% research ~ "Research",
      TRUE ~ "Other"
    )
  ) %>%
  count(Type, SeasonWords, sort = TRUE)

all_seas <- all %>%
  mutate(full_text = tolower(paste(TI, AB))) %>%
  group_by(PY) %>%
  summarize(season = sum(grepl("\\bseasons?\\b", full_text)),
            seasonality = sum(grepl("\\bseasonality\\b", full_text)))

all_season_plot <- all_seas %>%
  pivot_longer(c(season, seasonality)) %>%
  mutate(name = paste0('"',name,'"')) %>%
  left_join(lake, by = c("PY" = "Year")) %>%
  filter(PY >=1980, PY <= 2025) %>%
  ggplot(aes(x = PY, y = value/Count*100))+
  geom_point(alpha = 0.3)+
  ylab('Papers that mention "seasons" or\n"seasonality" (% of all lake papers in each year)')+
  geom_smooth(method = "gam", color = "black", linewidth = 0.5)+
  egg::theme_article()+
  theme(axis.title.x = element_blank())+
  facet_wrap(~name, scales = "free_y", ncol = 1)
```

Plot the use of different seasons over time

```{r}
#Add temperate seasons
with_temperate <- processed %>%
  select(SeasonWords, Spring, Summer, Autumn, Winter, PY) %>%
  mutate(
    TemperateSeasons = pmap(
      list(Spring, Summer, Autumn, Winter),
      ~ {
        seasons <- c(
          if (..1) "spring",
          if (..2) "summer",
          if (..3) "autumn",
          if (..4) "winter"
        )
        seasons
      }
    ),
    
    # combine with existing SeasonWords
    AllSeasons = map2(SeasonWords, TemperateSeasons, ~ unique(c(.x, .y)))
  ) %>%
  group_by(PY) %>%
  select(AllSeasons) %>%
  unnest(AllSeasons) %>%
  mutate(AllSeasons = gsub("[[:space:]-]$", "", AllSeasons)) %>%
  filter(!AllSeasons %in% filler_words,
         !AllSeasons %in% temporal_phases,
         !is.na(AllSeasons)) %>%   # remove filler words
  mutate(
    Type = case_when(
      AllSeasons %in% temperate ~ "Temperate",
      AllSeasons %in% flora ~ "Flora",
      AllSeasons %in% fauna ~ "Fauna",
      AllSeasons %in% ice ~ "Ice/Snow",
      AllSeasons %in% stratification ~ "Stratification",
      AllSeasons %in% temperature ~ "Temperature",
      AllSeasons %in% hydrology ~ "Hydrology",
      AllSeasons %in% agriculture ~ "Agriculture",
      AllSeasons %in% economic ~ "Economic",
      AllSeasons %in% research ~ "Research",
      TRUE ~ "Other"
    )
  )

with_temperate2 <- with_temperate %>%
  mutate(Meta = ifelse(AllSeasons %in% c("spring", "summer", "autumn","winter"),
                             "Temperate",
                             "Other")) %>%
  group_by(Type, Meta, PY) %>%
  count(AllSeasons, sort = TRUE) %>%
  group_by(AllSeasons) %>%
  mutate(sum_allseasons = sum(n)) %>%
  filter(sum_allseasons > 10)

sums <- with_temperate2 %>%
  ungroup() %>%
  complete(nesting(Type, Meta, AllSeasons), PY, fill = list(n = 0)) %>%
  ungroup() %>%
  mutate(total_overall = sum(n)) %>%
  left_join(lake, by = c("PY" = "Year")) %>%
  group_by(PY) %>%
  mutate(
    total_by_year = sum(n),
    pct_by_year   = n / total_by_year * 100,
    pct_of_all_by_year = n / Count * 100
  ) %>%
  group_by(Type, Meta) %>%
  mutate(total_by_type = sum(n)) %>%
  group_by(AllSeasons) %>%
  mutate(total_by_name = sum(n)) %>%
  ungroup() %>%
  arrange(desc(total_by_type), desc(total_by_name))

sums$AllSeasons <- factor(sums$AllSeasons, levels = unique(sums$AllSeasons))

label_data <- sums %>%
  ungroup() %>%
  arrange(desc(AllSeasons)) %>%
  filter(PY == 2025) %>%
  mutate(
    ymin = cumsum(lag(n, default = 0)),
    ymax = cumsum(n),
    ymid = (ymin + ymax) / 2
  ) %>%
  ungroup() %>%
  filter(n/total_by_year > 0.05)

sums %>%
  filter(PY >= 1980, 
         PY <= 2025) %>%
  ggplot(aes(x = PY, y = n, fill = Type))+
  geom_area(aes(group = AllSeasons), color = "white", linewidth = 0.1)+
  scale_fill_manual(values = colors)+
  scale_color_manual(values = colors)+
  guides(color = "none")+
  egg::theme_article()+
  scale_x_continuous(expand = expansion(mult = c(0, 0.1)))+
  geom_text(
    data = label_data,
    aes(x = 2025.5, y = ymid, color = Type, label = AllSeasons),
    hjust = 0,
    size = 3
  )

label_data_pct <- sums %>%
  ungroup() %>%
  arrange(desc(AllSeasons)) %>%
  filter(PY == 2025) %>%
  mutate(
    ymin = cumsum(lag(pct_of_all_by_year, default = 0)),
    ymax = cumsum(pct_of_all_by_year),
    ymid = (ymin + ymax) / 2
  ) %>%
  ungroup()

png("../03a_Figures/Total_prevalence.png", res = 300, width = 3.5, 
    height = 5, units = "in")
timeline <- sums %>%
  filter(PY >= 1980, 
         PY <= 2025) %>%
  mutate(class = factor(Meta, levels = c("Temperate", "Other"))) %>%
  ggplot(aes(x = PY, y = pct_of_all_by_year, color = Type))+
  geom_smooth(aes(group = AllSeasons), linewidth = 0.5, se = F, method = "gam")+
  scale_color_manual(values = colors)+
  egg::theme_article()+
  ylab("Papers that mention this season\n(% of all lake papers in each year)")+
  xlab("Publication year")+
  coord_cartesian(xlim = c(1980,2025),clip = "off", expand = c(0,0))+
  geom_hline(yintercept = 0, alpha = .1)+
  ggrepel::geom_text_repel(aes(x = 2026, label = AllSeasons), 
                           direction = "y",
                           hjust = 0,
                           #vjust = 0.5,
                           size = 3,
                           data = label_data_pct %>%
                             mutate(class = factor(Meta, levels = c("Temperate", "Other"))),
                           max.time = 5,
                           max.iter = 1000000,
                           box.padding= 0,
                           max.overlaps = 13,
                           force_pull = 1.5,
                           show.legend = F,
                           xlim = c(1980,2040),
                           min.segment.length = .1,
                           seed = 47)+
  guides(color = guide_legend(ncol = 3))+
  facet_wrap(~class, scales = "free_y", ncol = 1)+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.margin = unit(c(5.5, 40, 5.5, 5.5), units ="pt"))
timeline
dev.off()

png("../03a_Figures/Total_prevalence_comb.png", res = 300, width = 5.5, 
    height = 3.5, units = "in")
ggpubr::ggarrange(all_season_plot, 
                  timeline+
                    theme(legend.position = "none",
                          axis.title.x = element_blank())+
                    ylab("Papers that mention each season\n(% of all lake papers in each year)"), 
                  nrow = 1, widths = c(.9, 1), labels = c("a)", "b)"),
                  hjust = -0.1)
dev.off()
```

Identify countries

```{r}
places[, country_lower := tolower(country)]

# Extract country info
countries <- unique(places[, .(country, iso3)])
countries[, `:=`(
  country_lower = tolower(country),
  iso3_lower = tolower(iso3)
)]

#Set dt
papers <- setDT(processed %>%
                  select(full_text, SeasonWords))
places <- setDT(places)

#for iso3
countries_iso3 <- countries[!countries$iso3_lower %in%
                              c("and", "can", "ago", "are", "per")]

# Identify countries using functions sourced at the top of this script
#Warning: this will take a while!
papers[, Country := vapply(
  full_text,
  function(t) {
    t_lower <- tolower(t)  # normalize once
    
    # 1. Try full country / ISO3 detection
    ctry <- detect_country(t_lower)
    
    # 2. Try states
    if (length(ctry) == 0 || is.na(ctry)) {
      ctry <- detect_state(t_lower)
    }
    
    # 3. Try demonyms
    if (is.na(ctry)) {
      match_idx <- which(stri_detect_regex(t_lower, tolower(paste0("\\b", demonyms$Demonym, "\\b"))))
      if (length(match_idx) == 1) {
        ctry <- demonyms$Country[match_idx]
      } else if (length(match_idx) > 1) {
        ctry <- "Multi"
      } else {
        ctry <- NA_character_
      }
    }
    
    return(ctry)
  },
  FUN.VALUE = character(1)
)]

spat2 <- papers %>%
  as.data.frame()
sum(!is.na(spat2$Country))/nrow(spat2) #Currently matching ~72% of abstracts
spat_missing <- spat2 %>%
  filter(is.na(Country))

top5 <- spat2 %>%
  group_by(Country) %>%
  summarize(n_papers = n()) %>%
  arrange(desc(n_papers)) %>%
  filter(!Country == "Multi",
         !is.na(Country)) #%>%
  #head(5)

season_word_counts_spat <- spat2 %>%
  filter(!is.na(Country),
         !Country == "Multi") %>%
  select(SeasonWords, Country, full_text) %>%
  unnest(SeasonWords) %>%
  mutate(SeasonWords = gsub("[[:space:]-]$", "", SeasonWords)) %>%
  filter(!SeasonWords %in% filler_words,
         !SeasonWords %in% temporal_phases,
         !is.na(SeasonWords)) %>% 
  mutate(
    Type = case_when(
      SeasonWords %in% temperate ~ "Temperate",
      SeasonWords %in% flora ~ "Flora",
      SeasonWords %in% fauna ~ "Fauna",
      SeasonWords %in% ice ~ "Ice/Snow",
      SeasonWords %in% stratification ~ "Stratification",
      SeasonWords %in% temperature ~ "Temperature",
      SeasonWords %in% hydrology ~ "Hydrology",
      SeasonWords %in% agriculture ~ "Agriculture",
      SeasonWords %in% economic ~ "Economic",
      SeasonWords %in% research ~ "Research",
      TRUE ~ "Other"
    )
  ) %>%
  filter(!Type == "Other") %>%
  group_by(Country) %>%
  mutate(n_papers = length(unique(full_text)),
         Country_no_num = Country,
         Country = paste0(Country, "\n(n = ", n_papers,")")) %>%
  ungroup() %>%
  count(Type, SeasonWords, Country, Country_no_num, sort = TRUE)
```


NOT temperate

```{r}
season_word_counts_plot <- season_word_counts %>%
  filter(n > 10) %>%
  filter(!Type == "Temperate")

sum_seas <- sum(season_word_counts_plot$n, na.rm = T)

seasons_by_cat <- season_word_counts_plot %>%
  group_by(Type) %>%
  summarize(total_by_type = sum(n)) %>% 
  arrange(desc(total_by_type)) %>%
  mutate(Type = paste0(Type, "\n(n = ", total_by_type, ")"))

secondLevel = seasons_by_cat %>%
  arrange(desc(total_by_type)) %>%
  mutate(running = cumsum(total_by_type), 
         pos=running - total_by_type/2) %>% 
  rowwise() %>% 
  mutate(angle = compute_angle(pos / sum_seas))

thirdLevel = season_word_counts_plot %>%
  mutate(total_overall = sum(n)) %>%
  group_by(Type) %>%
  mutate(total_by_type = sum(n)) %>% 
  ungroup() %>%
  arrange(desc(total_by_type),
          desc(n)) %>%
  mutate(running = cumsum(n), 
         pos=running - n/2,
         Type = paste0(Type, "\n(n = ", total_by_type, ")")) %>% 
  rowwise() %>% 
  mutate(angle = compute_angle(pos / sum_seas),
         hjust = ifelse(pos/sum_seas > 0.5, 1, 0),
         label = SeasonWords, #paste0(SeasonWords, " (", comma(n), ")"),
         label = ifelse(n/total_overall < 0.01, "", label))

secondLevel$Type <- factor(secondLevel$Type, 
                           levels = rev(seasons_by_cat$Type))

thirdLevel$Type <- factor(thirdLevel$Type, 
                          levels = rev(seasons_by_cat$Type))

og <- ggplot() +
  geom_bar(data=thirdLevel,
           aes(x=5, y=n, fill = Type),
           color = "white",linewidth = 0.2,
           position='stack', stat='identity', 
           alpha = 0.5, width = 2) +
  geom_bar(data=secondLevel,
           aes(x=3, y=total_by_type, fill=Type),
           width = 2,color = "white",linewidth = 0.2,
           position='stack', stat='identity')+
  
  #geom_segment(data=secondLevel %>% ungroup() %>% mutate(prev = lag(running),
  #                                         prev = ifelse(is.na(prev), 0, prev)),
  #         aes(x=4, y = prev, yend=running, color=Type), linewidth = 1.5)+
  geom_text(data=thirdLevel, 
            aes(label=label, x=6.2, y=pos, angle=angle, 
                hjust = hjust, color = Type), show.legend = F
            ) +
  xlim(c(0,8))+
  coord_polar('y')+
  scale_color_manual(values= unname(colors), breaks = seasons_by_cat$Type) + 
  scale_fill_manual(values = unname(colors), breaks = seasons_by_cat$Type) + 
  theme_void()+
  ggtitle('Words that precede "season"')+
  guides(fill = guide_legend(title = NULL, nrow = 4)) + 
  theme(
    plot.title = element_text(hjust = 0.5, vjust = 0, size = 14),
    legend.position = "bottom",
    legend.box.margin = margin(t = -10),
    legend.margin = margin(t = -5),
    legend.spacing.y = unit(0, "pt"),
    plot.margin = margin(10, 0, 0, 0)
  )

season_word_counts_plot <- season_word_counts_spat %>%
  mutate(n_papers = as.numeric(str_extract(Country, "\\d+"))) %>%
  filter(n_papers >= 200)

country_levels <- c("Canada", "United States", "China", "India", "Ethiopia", "Brazil")
country_names <- season_word_counts_plot %>%
  select(Country_no_num, Country) %>%
  distinct() %>%
  filter(Country_no_num %in% country_levels) %>%
  mutate(
    Country_no_num = factor(Country_no_num, levels = country_levels)
  ) %>%
  arrange(Country_no_num) %>%
  pull(Country)

seasons_by_cat_i <- season_word_counts_plot %>%
  #filter(Country %in% top5$Country) %>%
  group_by(Type, Country) %>%
  summarize(total_by_type = sum(n)) %>% 
  arrange(desc(total_by_type)) %>%
  filter(!Type == "Temperate")

secondLevel = seasons_by_cat_i %>%
  group_by(Country) %>%
  arrange(desc(total_by_type)) %>%
  left_join(top5) %>%
  mutate(running = cumsum(total_by_type), 
         pos=running - total_by_type/2,
         sum_seas = sum(total_by_type)) %>% 
  rowwise() %>% 
  mutate(angle = compute_angle(pos / sum_seas),
         Country = factor(Country, levels = country_names))

thirdLevel = season_word_counts_plot %>%
  #filter(Country %in% top5$Country) %>%
  group_by(Type, Country) %>%
  mutate(total_by_type = sum(n)) %>% 
  group_by(Country) %>%
  arrange(desc(total_by_type),
          desc(n)) %>%
  mutate(running = cumsum(n), 
         pos=running - n/2,
         sum_seas = sum(total_by_type)) %>% 
  rowwise() %>% 
  mutate(angle = compute_angle(pos / sum_seas),
         hjust = ifelse(pos/sum_seas > 0.5, 1, 0),
         label = SeasonWords, #paste0(SeasonWords, " (", comma(n), ")"),
         label = ifelse(n < 30, "", label),
         Country = factor(Country, levels = country_names))

secondLevel$Type <- factor(secondLevel$Type, 
                           levels = rev(sub("\n\\(.+\\)","",seasons_by_cat$Type)))

thirdLevel$Type <- factor(thirdLevel$Type, 
                          levels = rev(sub("\n\\(.+\\)","",seasons_by_cat$Type)))

counts <- ggplot() +
  #geom_bar(data=thirdLevel,
  #         aes(x=5, y=n, fill = Type),
  #         color = "white",linewidth = 0.2,
  #         position='stack', stat='identity', 
  #         alpha = 0.5, width = 2) +
  geom_bar(data=secondLevel,
           aes(x=3, y=total_by_type, fill=Type),
           width = 2,color = "white",linewidth = 0.2,
           position='stack', stat='identity')+
  xlim(c(0,4))+
  coord_polar('y')+
  scale_color_manual(values = colors, breaks = sub(" \\(.+\\)","",seasons_by_cat$Type)) + 
  scale_fill_manual(values = colors, breaks = sub(" \\(.+\\)","",seasons_by_cat$Type)) + 
  theme_void()+
  guides(fill = guide_legend(title = NULL, ncol = 2)) + 
  theme(
    plot.title = element_text(hjust = 0.5, vjust = -6, size = 14),
    legend.position = "bottom",
    legend.box.margin = margin(t = -10),
    legend.margin = margin(t = -5),
    legend.spacing.y = unit(0, "pt"),
    plot.margin = margin(0, 0, 0, 0)
  )+
  facet_wrap(~Country, scales = "free_y")

og_comb <- og+
  guides(fill = guide_legend(title = NULL, ncol = 2))+ 
  theme(
    plot.title = element_text(hjust = 0.5, vjust = 1, size = 16),
    legend.position = "bottom",
    legend.box.margin = margin(t = -5),
    legend.margin = margin(t = 0),
    legend.spacing.y = unit(0, "pt"),
    plot.margin = margin(5, 0, 0, 0)
  )

jpeg("../03a_Figures/Sunburst_by_country_comb_with_timeline.jpg", res = 300, width = 6.5, height = 7, units = "in")
ggpubr::ggarrange(ggpubr::ggarrange(og_comb+
                                      theme(legend.position = "none"), 
                                    timeline+
                                      theme(legend.position = "none"),
                                    ncol = 1, nrow = 2, labels = c("a)","c)"),
                                    heights = c(1,.9)),
                  ggpubr::ggarrange(counts +
                                      facet_wrap(~Country, scales = "free_y", ncol = 2)+ 
                                      theme(legend.position = "none"),
                                    ggpubr::get_legend(og_comb),
                                    ncol = 1, heights = c(1,.4), labels = c("b)","")),  
                  ncol = 2, nrow = 1, widths = c(1,.7))
dev.off()

jpeg("../03a_Figures/Sunburst_by_country_comb_with_timeline_wide.jpg", res = 300, width = 9, height = 4.5, units = "in")
ggpubr::ggarrange(og_comb +
                    guides(fill = guide_legend(title = NULL, ncol = 3)),
                  counts +
                    facet_wrap(~Country, scales = "free_y", ncol = 2)+
                    theme(legend.position = "none"),
                  timeline+
                    theme(legend.position = "none"),
                  ncol = 3, nrow = 1, widths = c(1,.7,.8), labels = c("a)", "b)", "c)"))
dev.off()

jpeg("../03a_Figures/Sunburst_by_country_comb_with_timeline_wide2.jpg", res = 300, width = 9, height = 4.5, units = "in")
ggpubr::ggarrange(og_comb +
                    guides(fill = guide_legend(title = NULL, ncol = 3)),
                  counts +
                    facet_wrap(~Country, scales = "free_y", ncol = 2)+
                    theme(legend.position = "none"),
                  ggpubr::ggarrange(all_season_plot,
                                    timeline+
                                      theme(legend.position = "none"),
                                    ncol = 1, nrow = 2, labels = c("c)", "d)"),
                                    heights = c(.5,1)),
                  ncol = 3, nrow = 1, widths = c(1,.7,.8), labels = c("a)", "b)", ""))
dev.off()

jpeg("../03a_Figures/Sunburst_by_country_comb_no_temperate.jpg", res = 300, width = 7, height = 6, units = "in")
ggpubr::ggarrange(og+
                    guides(fill = guide_legend(title = NULL, ncol = 3))+ 
                    theme(
                      plot.title = element_text(hjust = 0.5, vjust = 1, size = 16),
                      legend.position = "bottom",
                      legend.box.margin = margin(t = -5),
                      legend.margin = margin(t = 0),
                      legend.spacing.y = unit(0, "pt"),
                      plot.margin = margin(0, 0, 0, 0)
                    ), 
                  counts +
                    facet_wrap(~Country, scales = "free_y", ncol = 2)+ 
                    theme(legend.position = "none"), 
                  widths = c(1,.7))
dev.off()
```

