---
title: "Lit review"
author: "Abby Lewis"
date: "2025-10-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r}
files <- list.files("../05_Lit_review", full.names = T)
all <- read_delim(files, show_col_types = F, delim = "\t") %>%
  select(TI, AB, PY)

all_classified <- all %>%
  mutate(Spring = grepl("spring", TI, ignore.case = T) | 
           grepl("spring", AB, ignore.case = T),
         Summer = grepl("summer", TI, ignore.case = T) | 
           grepl("summer", AB, ignore.case = T),
         Autumn = grepl("autumn|fall", TI, ignore.case = T) | 
           grepl("autumn|fall", AB, ignore.case = T),
         Winter = grepl("winter", TI, ignore.case = T) | 
           grepl("winter", AB, ignore.case = T),
         Rainy = grepl("rainy?[-\\s]+seasons?|wet[-\\s]+seasons?", TI, ignore.case = T) | 
           grepl("rainy?[-\\s]+seasons?|wet[-\\s]+seasons?", AB, ignore.case = T),
         Dry = grepl("dry[-\\s]+seasons?", TI, ignore.case = T) | 
           grepl("dry[-\\s]+seasons?", AB, ignore.case = T))

jpeg("../03a_Figures/change_over_time.jpg", res = 300, width = 6, height = 4, units = "in")
all_classified %>%
  filter(PY < 2025,
         PY > 1980) %>% #Incomplete
  group_by(PY) %>%
  mutate(N = n()) %>%
  pivot_longer(Spring:Dry) %>%
  mutate(Temperate = ifelse(name %in% c("Spring", "Summer", "Autumn", "Winter"), "Temperate", "Other")) %>%
  group_by(name, PY, Temperate) %>%
  summarize(n = sum(value),
            tot = unique(N)) %>%
  ggplot(aes(x = PY, y = n/tot, color = name))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Temperate, scales = "free_y")+
  theme_bw()
dev.off()

processed <- all_classified %>%
  mutate(
    # Normalize "low water", "warm water" etc. before extraction
    TI = str_replace_all(TI,
                         regex("\\b([a-z]+)[-\\s]?water\\b", 
                               ignore_case = TRUE),
                         "\\1-water"),
    AB = str_replace_all(AB,
                         regex("\\b([a-z]+)[-\\s]?water\\b", 
                               ignore_case = TRUE),
                         "\\1-water"),
    
    # Normalize "low flow", "high flow" etc. before extraction
    TI = str_replace_all(TI,
                         regex("\\b([a-z]+)[-\\s]?flow\\b", 
                               ignore_case = TRUE),
                         "\\1-flow"),
    AB = str_replace_all(AB,
                         regex("\\b([a-z]+)[-\\s]?flow\\b", 
                               ignore_case = TRUE),
                         "\\1-flow"),
    
    # Normalize rain/rainy before extraction
    TI = str_replace_all(TI, regex("\\brain[[:space:]]+season\\b", 
                                   ignore_case = TRUE), "rainy season"),
    AB = str_replace_all(AB, regex("\\brain[[:space:]]+season\\b", 
                                   ignore_case = TRUE), "rainy season"),
    
    # Normalize ice free before extraction
    TI = str_replace_all(TI, regex("\\bice[[:space:]]+free[[:space:]]+season\\b", 
                                   ignore_case = TRUE), "ice-free season"),
    AB = str_replace_all(AB, regex("\\bice[[:space:]]+free[[:space:]]+season\\b", 
                                   ignore_case = TRUE), "ice-free season")
  ) %>%
  #Extract
  mutate(
    Type_TI = str_extract_all(TI, regex("\\b[\\w-]+(?=[\\s-]+seasons?\\b)", ignore_case = TRUE)),
    Type_AB = str_extract_all(AB, regex("\\b[\\w-]+(?=[\\s-]+season?\\b)", ignore_case = TRUE)),

    #Combine
    SeasonWords = map2(Type_TI, Type_AB, ~ unique(tolower(c(.x, .y))))
  )

# Define words to remove
filler_words <- c(
  #Prepositions
  "in", "on", "at", "by", "between", "of", "to", 
  "for","with", "within", "from","across",
  #Articles
  "a", "the", "that", "this", 
  #Conjunctions
  "and", "or",
  #Other
  "different", "each","same","one","per", "single", 
  "every", "multi", "any", "given", "following", 
  "either", "previous", "other")
temporal_phases <- c("early", "mid", "late", "first", "second", 
                     "end-of", "whole", "entire", "two", "four", 
                     "all", "normal")

#Define season types
temperate <- c("spring", "summer", "autumn", "winter", "fall")
flora <- c("wintering", "growth", "growing", "non-growing", 
           "nongrowing", "vegetative", "productive", "non-productive",
           "dormant", "bloom", "blooming", "vegetation", "fire")
fauna <- c("breeding", "spawning", "reproductive", "mating",
           "nesting","non-breeding", "nonbreeding", "migration")
ice <- c("ice-covered", "ice-free", "open-water", "melt", 
         "melting", "thaw", "snowmelt", "ice", "ice-cover", 
         "snow", "snow-free", "ablation")
stratification <- c("stratified", "mixing")
temperature <- c("cold", "cool", "warm", "hot", "warmer", "heating")
hydrology <- c("dry", "rainy", "wet","runoff", "hydrological", 
               "flood", "flooding",
               "high-water", "low-water", "high-flow",
               "low-flow", "non-flood", "rainfall", "monsoon",
               "post-monsoon", "pre-monsoon", "non-monsoon", "drought")
agriculture <- c("irrigation", "rice-growing", "cropping", 
                 "planting", "harvest", "wheat", "rice")
economic <- c("peak", "active", "fishing", "angling", "closed",
                "hunting", "tourist", "bathing", "swimming")
research <- c("field", "sampling")

#Check
#processed$AB[processed$SeasonWords == "closed"]

season_word_counts <- processed %>%
  select(SeasonWords) %>%
  unnest(SeasonWords) %>%
  mutate(SeasonWords = tolower(SeasonWords),
         SeasonWords = gsub("[[:space:]-]$", "", SeasonWords)) %>%
  filter(!SeasonWords %in% filler_words,
         !SeasonWords %in% temporal_phases,
         !is.na(SeasonWords)) %>%   # remove filler words
  mutate(
    Type = case_when(
      SeasonWords %in% temperate ~ "Temperate",
      SeasonWords %in% flora ~ "Flora",
      SeasonWords %in% fauna ~ "Fauna",
      SeasonWords %in% ice ~ "Ice/Snow",
      SeasonWords %in% stratification ~ "Stratification",
      SeasonWords %in% temperature ~ "Temperature",
      SeasonWords %in% hydrology ~ "Hydrology",
      SeasonWords %in% agriculture ~ "Agriculture",
      SeasonWords %in% economic ~ "Economic",
      SeasonWords %in% research ~ "Research",
      TRUE ~ "Other"
    )
  ) %>%
  count(Type, SeasonWords, sort = TRUE)

# Plot the results
jpeg("../03a_Figures/count.jpg", res = 300, width = 4, height = 12, units = "in")
season_word_counts %>%
  filter(n > 10) %>%
  ggplot(aes(y = reorder(SeasonWords, n), x = n, fill = Type)) +
  geom_col() +
  ylab("Word before 'season'")+
  xlab("Frequency")+
  theme_minimal(base_size = 14)
dev.off()
```

```{r}
season_word_counts_plot <- season_word_counts %>%
  filter(n > 10)

sum_seas <- sum(season_word_counts_plot$n, na.rm = T)

p1 <- season_word_counts_plot %>%
  filter(n > 10) %>%
  mutate(tot = sum_seas) %>%
  ggplot() +
  #geom_bar(aes(x=1, y=tot), fill='darkgrey', stat='identity') +
  geom_text(aes(x=1, y=tot/2, 
                label=paste(tot, 'total seasons')), color='white')+ 
  coord_polar('y')

seasons_by_cat <- season_word_counts_plot %>%
  filter(n > 10) %>%
  group_by(Type) %>%
  summarize(total_by_type = sum(n)) %>% 
  arrange(desc(total_by_type)) %>%
  mutate(Type = paste0(Type, " (n = ", total_by_type, ")"))

compute_angle = function(perc){
  angle = -1
  
  if(perc < 0.5) # 1st half [90, -90]
    angle = (180 - (perc/0.5) * 180) - 90
  else # 2nd half [90, -90]
    angle = (90 - ((perc - 0.5)/0.5) * 180)

  return(angle)
}

secondLevel = seasons_by_cat %>%
  arrange(desc(total_by_type)) %>%
  mutate(running = cumsum(total_by_type), 
         pos=running - total_by_type/2) %>% 
  rowwise() %>% 
  mutate(angle = compute_angle(pos / sum_seas))

thirdLevel = season_word_counts_plot %>%
  group_by(Type) %>%
  mutate(total_by_type = sum(n)) %>% 
  ungroup() %>%
  arrange(desc(total_by_type),
          desc(n)) %>%
  mutate(running = cumsum(n), 
         pos=running - n/2,
         Type = paste0(Type, " (n = ", total_by_type, ")")) %>% 
  rowwise() %>% 
  mutate(angle = compute_angle(pos / sum_seas),
         hjust = ifelse(pos/sum_seas > 0.5, 1, 0),
         label = SeasonWords, #paste0(SeasonWords, " (", comma(n), ")"),
         label = ifelse(n < 100, "", label))

secondLevel$Type <- factor(secondLevel$Type, 
                           levels = rev(seasons_by_cat$Type))

thirdLevel$Type <- factor(thirdLevel$Type, 
                          levels = rev(seasons_by_cat$Type))

colors <- c("#64c7cc", #hydrology
            "#11592b", #growing
            "#8f6521", #fauna
            "grey", #temperate
            "#8AB4E3", #ice
            "#99152b", #temperature
            "#e3c21b", #economic
            "#79ad24",#ag
            "#66450c",#research
            "#F6A2A2") #stratification

jpeg("../03a_Figures/Sunburst.jpg", res = 300, width = 6, height = 5, units = "in")
ggplot() +
  geom_bar(data=secondLevel,
           aes(x=3, y=total_by_type, fill=Type),
           width = 2,
           color='white', position='stack', stat='identity')+
  geom_bar(data=thirdLevel,
           aes(x=5, y=n, fill = Type),
           color = "white",
           position='stack', stat='identity', 
           alpha = 0.5, width = 2) +
  geom_text(data=thirdLevel, 
            aes(label=label, x=6.2, y=pos, angle=angle, 
                hjust = hjust), 
            color = "grey50"
            ) +
  xlim(c(0,8))+
  coord_polar('y')+
  scale_color_manual(values= colors, breaks = seasons_by_cat$Type) + 
  scale_fill_manual(values = colors, breaks = seasons_by_cat$Type) + 
  theme_void()+
  ggtitle('Words that preceed "season"')+
  guides(fill = guide_legend(title = NULL, nrow = 4)) + 
  theme(
    plot.title = element_text(hjust = 0.5, vjust = -6, size = 14),
    legend.position = "bottom",
    legend.box.margin = margin(t = -10),
    legend.margin = margin(t = -5),
    legend.spacing.y = unit(0, "pt"),
    plot.margin = margin(0, 0, 0, 0)
  )
dev.off()
```

