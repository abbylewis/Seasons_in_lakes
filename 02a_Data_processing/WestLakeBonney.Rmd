---
title: "West Lake Bonney"
author: "Dave Richardson"
date: "2025-09-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rLakeAnalyzer)

#Offset so all yday values are from the winter solstice
solstice <- as.Date("2023-06-21")
offset = as.Date("2024-01-01") - solstice
LAKE = "West Lake Bonney (2023-2024)"
```

All data in one file

```{r}
# Load data
#https://portal.edirepository.org/nis/mapbrowse?packageid=knb-lter-mcm.3204.1
in_lake_data <- read_csv("https://pasta.lternet.edu/package/data/eml/knb-lter-mcm/3204/1/781e602f85044544c1eda00e47fa7092") %>%
  mutate(Date=date_time,
         day = as.Date(date_time) + offset,
         yday = yday(day)) %>%
  filter(year(day) == 2024,
         !is.na(yday))

# Format continuous data
in_lake_formatted <- in_lake_data %>%
  select(day,yday,Date,stage_watertemp_degc,do_lower_watertemp_degc) %>%
  pivot_longer(c("stage_watertemp_degc","do_lower_watertemp_degc"),
               values_to = "Value") %>%
  group_by(name, Date) %>%
  filter(!is.na(Value)) %>%
  mutate(Layer = case_when(name == "stage_watertemp_degc"~"Surface",
                           name == "do_lower_watertemp_degc"~"Bottom")) %>%
  filter(!is.na(Layer)) %>%
  ungroup() %>%
  mutate(Variable=case_when(Layer=="Surface"~"Surface_temperature",
                              Layer=="Bottom"~"Bottom_temperature",
                              .default=NA
                              )
         ) %>%
  filter(!is.na(Variable)) %>%
  mutate(Lake = LAKE) %>%
  select(Variable, Value, yday, Lake)

write.csv(in_lake_formatted, "../01b_Processed_data/WestLakeBonney_continuous.csv", row.names = F)

# Stratification metric calcs (both discrete and continuous)
#Water density salinity from Figure 2 here: https://link.springer.com/article/10.1007/s00300-003-0582-0
strat_sum <- in_lake_formatted %>%
  filter(Variable %in% c("Surface_temperature", "Bottom_temperature")) %>%
  pivot_wider(names_from = "Variable", values_from = "Value") %>%
  mutate(Bottom_sal=130,Surface_sal=10)%>%
  mutate(Diff_Dens_surf_bot = water.density(Bottom_temperature,Bottom_sal) - 
           water.density(Surface_temperature, Surface_sal),
         Inverse = ifelse(Bottom_temperature > Surface_temperature,
                          T, F))

strat_export_discrete <- strat_sum %>%
  mutate(Strat = ifelse(Diff_Dens_surf_bot > 0.1, "Stratified", "Mixed"),
         Strat = ifelse(Inverse & Strat == "Stratified", "Inversely\nstratified", Strat)) %>%
  filter(!is.na(Strat)) %>%
  ungroup() %>%
  filter(Strat != lag(Strat)) %>%
  full_join(data.frame(Variable = "Diff_Dens_surf_bot", yday = 1, Strat = "Stratified")) %>%
  arrange(yday) %>%
  mutate(end = lead(yday, default = 365)) %>%
  rename(start = yday, Season = Strat) %>%
  select(start, end, Season) %>%
  mutate(Lake = LAKE)

strat_export_cont <- strat_sum %>%
  select(yday, Diff_Dens_surf_bot) %>%
  pivot_longer(Diff_Dens_surf_bot, names_to = "Variable", values_to = "Value") %>%
  mutate(Lake = LAKE)

write.csv(strat_export_discrete, 
          "../01b_Processed_data/WestLakeBonney_stratification_discrete.csv", 
          row.names = F)
write.csv(strat_export_cont, 
          "../01b_Processed_data/WestLakeBonney_stratification_continuous.csv", 
          row.names = F)
```

Meteorological data

```{r}
# Load data
met <- read_csv("https://pasta.lternet.edu/package/data/eml/knb-lter-mcm/7003/22/b7702f38a033bf70ff4752f49886e82b")

# Format continuous data
met_formatted <- met %>%
  #filter(Lake == "West Lake Bonney (2023)") %>%
  mutate(Date = as.Date(date_time) + offset,
         doy = yday(Date)) %>%
  filter(year(Date) == 2023) %>%
  rename(AirTemp_C_Average = airtemp_1m_degc,
         Shortwave = swradin_wm2) %>%
  pivot_longer(c(AirTemp_C_Average, Shortwave), names_to = "Variable", values_to = "Value") %>%
  mutate(yday = yday(Date)) %>%
  select(Variable, Value, yday) %>%
  mutate(Lake = LAKE)

write.csv(met_formatted, "../01b_Processed_data/WestLakeBonney_met.csv", row.names = F)
```

Ice data

```{r}
#Load data

ice_formatted <- tibble(Lake="West Lake Bonney",Season="Ice",Method="Ice",start=0,end=365)

write.csv(ice_formatted, "../01b_Processed_data/WestLakeBonney_ice.csv", row.names = F)
```
